<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>P2P Planning Poker</title>
  <link rel="stylesheet" href="room.css">
</head>
<body>
    <div style="display: flex; height: 85vh;">
        <div style="flex: 1; overflow: auto; padding: 1em;">
            <div id="log" style="flex: 1; overflow: auto; padding: 1em;height: 50%"></div>
            <div id="table" style="border-top: 1px solid #ccc; flex: 1; justify-content: center; align-items: center; overflow: auto; padding: 1em;height: 50%; display: flex"></div>
        </div>
        <div style="width: 200px; border-left: 1px solid #ccc; padding: 1em; overflow-y: auto;">
            <b>Users</b><br/>
            <div id ="users" style="max-height: 80vh; overflow-y: auto; border-top: 1px solid #ccc; padding-top: 1em; margin-top: 1em;">
            </div>
        </div>
    </div>
    <div style="border-top: 1px solid #ccc; margin-top: 1em;">
        <input id="usr" style="width: 20vw; height: 6vh;" placeholder="Username" onchange="send('nick')" >
        <select id="card" style="width: 20vw; height: 8vh;">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="8">8</option>
            <option value="13">13</option>
            <option value="21">21</option>
            <option value="?">?</option>
        </select>
        <button onclick="send('card')" style="height: 8vh; width: 15vh; vertical-align: top;" >Vote</button>
        <button onclick="send('reveal')" style="height: 8vh; width: 15vh; vertical-align: top;" >Reveal</button>
        <button onclick="send('clear')" style="height: 8vh; width: 15vh; vertical-align: top;" >Clear</button>
    </div>
  <script src="peerjs.min.js"></script>
  <script src="log.js"></script>
  <script src="room.js"></script>
  <script>
      let msgs = [];
      let tableDiv = document.getElementById("table");

      function handleReveal(data) {
          for (let m of msgs) {
              m.hidden = false;
          }
          for (let m of msgs) {
              if(m.what === "card") {
                  handle(m);
              }
          }
          let length = msgs.length;
          msgs = [];
          return "<i>Round revealed by " + userHTML(data.usr) + " with " + length + " vote(s)</i>";
      }

      function cardHTML(value) {
          return '<a style="display: inline-block; width: auto; border: 1px solid black; border-radius: 3px; padding: 7px; margin: 7px;">' + value + '</a>'
      }

      function cardHTMLFromData(data) {
          let value = data.hidden ? "â–ˆ" : cleanHTML(data.card);
          return cardHTML(value);
      }

      function cardHTMLWithUserFromData(data) {
          return '<div style="text-align: center;"><div>' + cardHTMLFromData(data) + '</div><div>' + userHTML(data.usr) + '</div></div>';
      };

      function drawAllCards(data) {
          tableDiv.innerHTML = "";
          let lastCardsForUsers = {};
          for (let m of msgs) {
              lastCardsForUsers[m.peerId] = m;
          }
          for (let peerId in lastCardsForUsers) {
              if (lastCardsForUsers[peerId].what === "card") {
                  tableDiv.innerHTML += cardHTMLWithUserFromData(lastCardsForUsers[peerId]);
              }
          }
      }

      function handle(data) {
          console.log(data);
          let i = false;
          let txt = null;
          if(data.what === "reveal") {
              txt = handleReveal(data);
          } else if (data.what === "nick") {
              i = true;
              txt = "Nickname: " + userHTML(data.usr)
          } else if (data.what === "card") {
              if (data.hidden) {
                  msgs.push(data);
                  txt = "Received card from: " + userHTML(data.usr)
                  i = true;
              }
              drawAllCards(data);
          } else if (data.what == "clear") {
              logDiv.innerHTML = "";
              tableDiv.innerHTML = "";
              msgs = [];
              txt = "Chat and votes cleared by " + userHTML(data.usr);
              i = true;
          }
          if(txt !== null) {
              log(txt, i);
          }
      }

      function onUsersUpdate(users) {
          let usersDiv = document.getElementById("users");
          usersDiv.innerHTML = "";
          for (let peerId in users) {
              if (users.hasOwnProperty(peerId)) {
                  let user = users[peerId];
                  usersDiv.innerHTML += "<div>" + userHTML(user) + "</div>";
              }
          }
      }


      function buildPayload(what) {
          return {
              "what": what,
              "card": card.value,
              "hidden": true
          };
      }
  </script>
</body> 
</html> 

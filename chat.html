 <!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>PeerJS Room Chat</title>
</head>
<body>
  <div style="width: 100vw; height: 70vh;" id="log"></div>
  Username: <input id="usr" placeholder="Username"><br/>
  <textarea id="msg" style="width: 80vw; height: 20vh;" placeholder="Message"></textarea>
  <button onclick="send()" style="height: 20vh; width: 20vh; vertical-align: top;" >Send</button>
  <script src="peerjs.min.js"></script>
  <script>
      const isServer = location.hash === "#host";
      const connections = [];

      function log(txt, i = false) {
          console.log(txt);
          if (typeof txt === "object") {
              txt = "" + txt.time + " " + "<b>" + cleanHTML(txt.usr) + "</b>: " + cleanHTML(txt.msg);
          }
          if (i) {
              txt = "<i>" + txt + "</i>";
          }
          const logDiv = document.getElementById("log");
          logDiv.innerHTML += txt + "<br>";
          logDiv.scrollTop = logDiv.scrollHeight;
      }

      function logi(txt) {
          log(txt, true);
      }

      function cleanHTML(str) {
          return new DOMParser().parseFromString(str, "text/html").body.textContent;
      }

      window.send = () => {
          const text = {
              "usr": usr.value,
              "msg": msg.value,
              "time": new Date().toLocaleTimeString()
          };
          log(text);
          connections.forEach(c => c.send(text));
      };

      if(isServer) {
          const roomName = crypto.randomUUID();
          const peer = new Peer(roomName);
          peer.on('open', id => {
              const newUrl = location.href.replace(/#host/, `#${roomName}`);
              logi("starting server with ID: " + id);
              logi("running at <a href='" + newUrl + "'>" + newUrl + "</a>");
          });
          peer.on('connection', conn => {
              logi("New connection: " + conn.peer);
              connections.push(conn);
              conn.on('data', data => {
                  log(data);
                  connections.forEach(c => {
                      if (c !== conn) c.send(data);
                  });
              });
          });
      } else {
          const peer = new Peer();
          peer.on('open', id => {
               const roomName = location.hash.replace("#", "");
              logi("starting client with ID: " + id);
              const conn = peer.connect(roomName);
              conn.on('open', () => {
                  logi("Connected to host");
                  conn.on('data', data => log(data));
                  connections.push(conn);
              });
          });
      }

  </script>
</body> 
</html>
